import e from"pako";import{Struct as t,UInt64 as n,Serializer as r,Bytes as i,Checksum256 as o,PermissionLevel as s,PublicKey as a,Name as c,PrivateKey as u,Signature as f,SignedTransaction as l,APIClient as h}from"@greymass/eosio";import{SigningRequest as p,ResolvedSigningRequest as d,PlaceholderName as v,PlaceholderPermission as m,ChainId as y}from"eosio-signing-request";export{PlaceholderAuth,PlaceholderName,PlaceholderPermission}from"eosio-signing-request";import g from"fetch-ponyfill";import{AES_CBC as b}from"asmcrypto.js";import{v4 as w}from"uuid";import P from"isomorphic-ws";function k(){return(k=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function S(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}function _(e){return(_=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function q(e,t){return(q=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function O(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function j(e,t,n){return(j=O()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&q(i,n.prototype),i}).apply(null,arguments)}function x(e){var t="function"==typeof Map?new Map:void 0;return(x=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return j(e,arguments,_(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),q(n,e)})(e)}var E,R=function(e){function t(t){var n;return(n=e.call(this,"User canceled request "+(t?"("+t+")":""))||this).code="E_CANCEL",n}return S(t,e),t}(x(Error)),K=function(e){function t(t){var n;return(n=e.call(this,"Unable to verify identity "+(t?"("+t+")":""))||this).code="E_IDENTITY",n}return S(t,e),t}(x(Error)),I=function(e){function t(t,n){var r;return(r=e.call(this,t)||this).code=n,r}return S(t,e),t}(x(Error));function T(e,t,n,r){var i,o=arguments.length,s=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,n,s):i(t,n))||s);return o>3&&s&&Object.defineProperty(t,n,s),s}!function(e){e.defaults={chainId:"aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906",client:"https://eos.greymass.com",service:"https://cb.anchor.link"}}(E||(E={}));var N=function(e){function t(){return e.apply(this,arguments)||this}return S(t,e),t}(t);T([t.field("public_key")],N.prototype,"from",void 0),T([t.field("uint64")],N.prototype,"nonce",void 0),T([t.field("bytes")],N.prototype,"ciphertext",void 0),T([t.field("uint32")],N.prototype,"checksum",void 0),N=T([t.type("sealed_message")],N);var U=function(e){function t(){return e.apply(this,arguments)||this}return S(t,e),t}(t);T([t.field("name")],U.prototype,"session_name",void 0),T([t.field("public_key")],U.prototype,"request_key",void 0),U=T([t.type("link_create")],U);var D=function(e){function t(){return e.apply(this,arguments)||this}return S(t,e),t}(t);T([t.field("time_point_sec")],D.prototype,"expiration",void 0),D=T([t.type("link_info")],D);var F=g().fetch,L=function(){function e(){}return e.prototype.remove=function(){try{var e=this,t=function(){if(e.link.storage)return Promise.resolve(e.link.removeSession(e.identifier,e.auth)).then(function(){})}();return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},e.restore=function(e,t){switch(t.type){case"channel":return new C(e,t.data,t.metadata);case"fallback":return new A(e,t.data,t.metadata);default:throw new Error("Unable to restore, session data invalid")}},e}(),C=function(e){function t(t,f,l){var h;(h=e.call(this)||this).type="channel",h.timeout=12e4,h.link=t,h.auth=s.from(f.auth),h.publicKey=a.from(f.publicKey),h.channel=f.channel,h.identifier=c.from(f.identifier);var p=u.from(f.requestKey),d=a.from(f.channel.key);return h.encrypt=function(e){return function(e,t,s,a){var c=t.sharedSecret(s);a||(a=n.random());var u=r.encode({object:a}).appending(c.array).sha512Digest,f=new b(u.array.slice(0,32),u.array.slice(32,48)),l=i.from(f.encrypt(i.from(e,"utf8").array)),h=new DataView(o.hash(u.array).array.buffer).getUint32(0,!0);return N.from({from:t.toPublic(),nonce:a,ciphertext:l,checksum:h})}(e.encode(!0,!1),p,d)},h.metadata=k({},l||{},{timeout:h.timeout,name:h.channel.name}),h.serialize=function(){return{type:"channel",data:f,metadata:h.metadata}},h}S(t,e);var f=t.prototype;return f.onSuccess=function(e,t){this.link.transport.onSuccess&&this.link.transport.onSuccess(e,t)},f.onFailure=function(e,t){this.link.transport.onFailure&&this.link.transport.onFailure(e,t)},f.onRequest=function(e,t){var n=D.from({expiration:new Date(Date.now()+this.timeout).toISOString().slice(0,-1)});this.link.transport.onSessionRequest&&this.link.transport.onSessionRequest(this,e,t),setTimeout(function(){t(new I("Wallet did not respond in time","E_TIMEOUT"))},this.timeout+500),e.setInfoKey("link",n),F(this.channel.url,{method:"POST",headers:{"X-Buoy-Wait":(this.timeout/1e3).toFixed(0)},body:r.encode({object:this.encrypt(e)}).array}).then(function(e){200!==e.status&&t(new I("Unable to push message","E_DELIVERY"))}).catch(function(e){t(new I("Unable to reach link service ("+(e.message||String(e))+")","E_DELIVERY"))})},f.prepare=function(e){return this.link.transport.prepare?this.link.transport.prepare(e,this):Promise.resolve(e)},f.showLoading=function(){if(this.link.transport.showLoading)return this.link.transport.showLoading()},f.makeSignatureProvider=function(){return this.link.makeSignatureProvider([this.publicKey.toString()],this)},f.transact=function(e,t){return this.link.transact(e,t,this)},t}(L),A=function(e){function t(t,n,r){var i;return(i=e.call(this)||this).type="fallback",i.link=t,i.auth=s.from(n.auth),i.publicKey=a.from(n.publicKey),i.metadata=r||{},i.identifier=c.from(n.identifier),i.serialize=function(){return{type:i.type,data:n,metadata:i.metadata}},i}S(t,e);var n=t.prototype;return n.onSuccess=function(e,t){this.link.transport.onSuccess&&this.link.transport.onSuccess(e,t)},n.onFailure=function(e,t){this.link.transport.onFailure&&this.link.transport.onFailure(e,t)},n.onRequest=function(e,t){this.link.transport.onSessionRequest?this.link.transport.onSessionRequest(this,e,t):this.link.transport.onRequest(e,t)},n.prepare=function(e){return this.link.transport.prepare?this.link.transport.prepare(e,this):Promise.resolve(e)},n.showLoading=function(){if(this.link.transport.showLoading)return this.link.transport.showLoading()},n.makeSignatureProvider=function(){return this.link.makeSignatureProvider([this.publicKey.toString()],this)},n.transact=function(e,t){return this.link.transact(e,t,this)},t}(L);function J(e,t,n){if(!e.s){if(n instanceof M){if(!n.s)return void(n.o=J.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(J.bind(null,e,t),J.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var M=function(){function e(){}return e.prototype.then=function(t,n){var r=new e,i=this.s;if(i){var o=1&i?t:n;if(o){try{J(r,1,o(this.v))}catch(e){J(r,2,e)}return r}return this}return this.o=function(e){try{var i=e.v;1&e.s?J(r,1,t?t(i):i):n?J(r,1,n(i)):J(r,2,i)}catch(e){J(r,2,e)}},r},e}();function z(e){return e instanceof M&&1&e.s}var B=function(){function e(e){this.address=e.trim().replace(/\/$/,"")}return e.prototype.create=function(){var e=this.address+"/"+w();return new V(e)},e}(),V=function(){function e(e){this.url=e,this.ctx={}}var t=e.prototype;return t.wait=function(){return this.url.includes("hyperbuoy")?function(e,t){try{var n,r=function(e){return n?e:new Promise(function(){})},i=!0;t.cancel=function(){i=!1};var o=function(e,t,n){for(var r;;){var i=e();if(z(i)&&(i=i.v),!i)return o;if(i.then){r=0;break}var o=n();if(o&&o.then){if(!z(o)){r=1;break}o=o.s}}var s=new M,a=J.bind(null,s,2);return(0===r?i.then(u):1===r?o.then(c):(void 0).then(function(){(i=e())?i.then?i.then(u).then(void 0,a):u(i):J(s,1,o)})).then(void 0,a),s;function c(t){o=t;do{if(!(i=e())||z(i)&&!i.v)return void J(s,1,o);if(i.then)return void i.then(u).then(void 0,a);z(o=n())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,a)}function u(e){e?(o=n())&&o.then?o.then(c).then(void 0,a):c(o):J(s,1,o)}}(function(){return!n&&!!i},0,function(){function t(e){return n?e:Promise.resolve(new Promise(function(e){setTimeout(e,1e3)})).then(function(){})}var r=function(t,r){try{var i=Promise.resolve(F(e)).then(function(e){return function(){if(408!==e.status){if(200===e.status)return n=1,Promise.resolve(e.json());throw new Error("HTTP "+e.status+": "+e.statusText)}}()})}catch(e){return r(e)}return i&&i.then?i.then(void 0,r):i}(0,function(e){console.warn("Unexpected hyperbuoy error",e)});return r&&r.then?r.then(t):t(r)});return Promise.resolve(o&&o.then?o.then(r):r(o))}catch(e){return Promise.reject(e)}}(this.url,this.ctx):(e=this.url,t=this.ctx,new Promise(function(n,r){var i=!0,o=0,s=e.replace(/^http/,"ws"),a=function(e){try{n(JSON.parse(e))}catch(e){e.message="Unable to parse callback JSON: "+e.message,r(e)}};!function e(){var n=new P(s);t.cancel=function(){i=!1,n.readyState!==P.OPEN&&n.readyState!==P.CONNECTING||n.close()},n.onmessage=function(e){if(i=!1,n.readyState===P.OPEN&&n.close(),"undefined"!=typeof Blob&&e.data instanceof Blob){var t=new FileReader;t.onload=function(){a(t.result)},t.onerror=function(e){r(e)},t.readAsText(e.data)}else a("string"==typeof e.data?e.data:e.data.toString())},n.onopen=function(){o=0},n.onclose=function(){var t;i&&setTimeout(e,(t=o++,Math.min(Math.pow(10*t,2),1e4)))}}()}));var e,t},t.cancel=function(){this.ctx.cancel&&this.ctx.cancel()},e}();function W(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var Y="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function G(e,t,n){if(!e.s){if(n instanceof H){if(!n.s)return void(n.o=G.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(G.bind(null,e,t),G.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var H=function(){function e(){}return e.prototype.then=function(t,n){var r=new e,i=this.s;if(i){var o=1&i?t:n;if(o){try{G(r,1,o(this.v))}catch(e){G(r,2,e)}return r}return this}return this.o=function(e){try{var i=e.v;1&e.s?G(r,1,t?t(i):i):n?G(r,1,n(i)):G(r,2,i)}catch(e){G(r,2,e)}},r},e}();function X(e){return e instanceof H&&1&e.s}var $=function(){function t(t){if(this.abiCache=new Map,this.pendingAbis=new Map,"object"!=typeof t)throw new TypeError("Missing options object");if(!t.transport)throw new TypeError("options.transport is required, see https://github.com/greymass/anchor-link#transports");this.client=void 0===t.client||"string"==typeof t.client?new h({url:t.client||E.defaults.client}):t.client,this.chainId=y.from(t.chainId||E.defaults.chainId),this.callbackService=void 0===t.service||"string"==typeof t.service?new B(t.service||E.defaults.service):t.service,this.transport=t.transport,null!==t.storage&&(this.storage=t.storage||this.transport.storage),this.requestOptions={abiProvider:this,zlib:e}}var n=t.prototype;return n.getAbi=function(e){try{var t=this,n=e.toString(),r=t.abiCache.get(n),i=function(){if(!r){var i=t.pendingAbis.get(n);return i||(i=t.client.v1.chain.get_abi(e),t.pendingAbis.set(n,i)),Promise.resolve(i).then(function(e){r=e.abi,t.pendingAbis.delete(n),r&&t.abiCache.set(n,r)})}}();return Promise.resolve(i&&i.then?i.then(function(){return r}):r)}catch(e){return Promise.reject(e)}},n.createRequest=function(e,t){try{var n=this,r=t||n.transport;return Promise.resolve(p.create(k({},e,{chainId:n.chainId.toString(),broadcast:!1}),n.requestOptions)).then(function(e){function t(){var t=n.callbackService.create();return e.setCallback(t.url,!0),{request:e,callback:t}}var i=function(){if(r.prepare)return Promise.resolve(r.prepare(e)).then(function(t){e=t})}();return i&&i.then?i.then(t):t()})}catch(e){return Promise.reject(e)}},n.sendRequest=function(e,t,n,r){void 0===r&&(r=!1);try{var i=this,o=n||i.transport;return Promise.resolve(W(function(){if(e.data.callback!==t.url)throw new Error("Invalid request callback");if(!0===e.data.flags.broadcast||!1===e.data.flags.background)throw new Error("Invalid request flags");var n=new Promise(function(n,r){o.onRequest(e,function(e){t.cancel(),r("string"==typeof e?new R(e):e)})});return Promise.resolve(Promise.race([t.wait(),n])).then(function(t){var n=s.from({actor:t.sa,permission:t.sp}),a=Object.keys(t).filter(function(e){return e.startsWith("sig")&&"sig0"!==e}).map(function(e){return f.from(t[e])});return Promise.resolve(d.fromPayload(t,i.requestOptions)).then(function(s){function c(){return o.onSuccess&&o.onSuccess(e,h),h}var u=s.request.getInfoKey("fuel_sig","string");u&&a.unshift(f.from(u));var h={request:s.request,transaction:s.transaction,resolvedTransaction:s.resolvedTransaction,signatures:a,payload:t,signer:n},p=function(){if(r){var e=l.from(k({},s.transaction,{signatures:a}));return Promise.resolve(i.client.v1.chain.push_transaction(e)).then(function(e){h.processed=e.processed})}}();return p&&p.then?p.then(c):c()})})},function(t){throw o.onFailure&&o.onFailure(e,t),t}))}catch(e){return Promise.reject(e)}},n.transact=function(e,t,n){try{var r=this,i=n||r.transport,o=!t||!1!==t.broadcast;return i&&i.showLoading&&i.showLoading(),e.actions&&(e.expiration||e.ref_block_num||e.ref_block_prefix||e.max_net_usage_words||e.max_cpu_usage_ms||e.delay_sec)&&(e={transaction:k({expiration:"1970-01-01T00:00:00",ref_block_num:0,ref_block_prefix:0,max_net_usage_words:0,max_cpu_usage_ms:0,delay_sec:0},e)}),Promise.resolve(r.createRequest(e,i)).then(function(e){return Promise.resolve(r.sendRequest(e.request,e.callback,i,o))})}catch(e){return Promise.reject(e)}},n.identify=function(e){try{var t=this;return Promise.resolve(t.createRequest({identity:{permission:e.requestPermission,scope:e.scope},info:e.info})).then(function(n){var r=n.request;return Promise.resolve(t.sendRequest(r,n.callback)).then(function(n){if(!n.request.isIdentity())throw new K("Unexpected response");var i=n.transaction.signingDigest(r.getChainId()),o=n.signatures[0].recoverDigest(i),a=n.signer;return Promise.resolve(t.client.v1.chain.get_account(a.actor)).then(function(t){if(!t)throw new K("Signature from unknown account: "+a.actor);var r=t.permissions.find(function(e){return a.permission.equals(e.perm_name)});if(!r)throw new K(a.actor+" signed for unknown permission: "+a.permission);var i=r.required_auth,c=i.keys.find(function(e){return o.equals(e.key)});if(!c)throw new K(Q(a)+" has no key matching id signature ("+o+")");if(i.threshold>c.weight)throw new K(Q(a)+" signature does not reach auth threshold");if(e.requestPermission){var u=s.from(e.requestPermission);if(!u.actor.equals(v)&&!u.actor.equals(a.actor)||!u.permission.equals(m)&&!u.permission.equals(a.permission))throw new K("Unexpected identity proof from "+Q(a)+", expected "+Q(u)+" ")}return k({},n,{account:t,signerKey:o})})})})}catch(e){return Promise.reject(e)}},n.login=function(e){try{var t=this,n=u.generate("K1"),r=n.toPublic(),i=U.from({session_name:e,request_key:r});return Promise.resolve(t.identify({scope:e,info:{link:i,scope:e}})).then(function(r){function i(){return k({},r,{session:o})}var o,s={sameDevice:void 0!==r.request.getRawInfo().return_path};o=r.payload.link_ch&&r.payload.link_key&&r.payload.link_name?new C(t,{identifier:e,auth:r.signer,publicKey:r.signerKey,channel:{url:r.payload.link_ch,key:r.payload.link_key,name:r.payload.link_name},requestKey:n},s):new A(t,{identifier:e,auth:r.signer,publicKey:r.signerKey},s);var a=function(){if(t.storage)return Promise.resolve(t.storeSession(e,o)).then(function(){})}();return a&&a.then?a.then(i):i()})}catch(e){return Promise.reject(e)}},n.restoreSession=function(e,t){try{var n,r,i=function(i){return n?i:Promise.resolve(o.storage.read(r)).then(function(n){if(!n)return null;var r;try{r=JSON.parse(n)}catch(e){throw new Error("Unable to restore session: Stored JSON invalid ("+(e.message||String(e))+")")}var i=L.restore(o,r),s=function(){if(t)return Promise.resolve(o.touchSession(e,t)).then(function(){})}();return s&&s.then?s.then(function(){return i}):i})},o=this;if(!o.storage)throw new Error("Unable to restore session: No storage adapter configured");var s=function(){if(!t)return Promise.resolve(o.listSessions(e)).then(function(t){var i=t[0];if(!i)return n=1,null;r=o.sessionKey(e,Q(i))});r=o.sessionKey(e,Q(t))}();return Promise.resolve(s&&s.then?s.then(i):i(s))}catch(e){return Promise.reject(e)}},n.listSessions=function(e){try{var t=this;if(!t.storage)throw new Error("Unable to list sessions: No storage adapter configured");var n,r=t.sessionKey(e,"list"),i=W(function(){return Promise.resolve(t.storage.read(r)).then(function(e){n=JSON.parse(e||"[]")})},function(e){throw new Error("Unable to list sessions: Stored JSON invalid ("+(e.message||String(e))+")")});return Promise.resolve(i&&i.then?i.then(function(e){return n}):n)}catch(e){return Promise.reject(e)}},n.removeSession=function(e,t){try{var n=this;if(!n.storage)throw new Error("Unable to remove session: No storage adapter configured");var r=n.sessionKey(e,Q(t));return Promise.resolve(n.storage.remove(r)).then(function(){return Promise.resolve(n.touchSession(e,t,!0)).then(function(){})})}catch(e){return Promise.reject(e)}},n.clearSessions=function(e){try{var t=this;if(!t.storage)throw new Error("Unable to clear sessions: No storage adapter configured");return Promise.resolve(t.listSessions(e)).then(function(n){var r=function(e,t,n){if("function"==typeof e[Y]){var r,i,o,s=e[Y]();if(function e(n){try{for(;!(r=s.next()).done;)if((n=t(r.value))&&n.then){if(!X(n))return void n.then(e,o||(o=G.bind(null,i=new H,2)));n=n.v}i?G(i,1,n):i=n}catch(e){G(i||(i=new H),2,e)}}(),s.return){var a=function(e){try{r.done||s.return()}catch(e){}return e};if(i&&i.then)return i.then(a,function(e){throw a(e)});a()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var c=[],u=0;u<e.length;u++)c.push(e[u]);return function(e,t,n){var r,i,o=-1;return function n(s){try{for(;++o<e.length;)if((s=t(o))&&s.then){if(!X(s))return void s.then(n,i||(i=G.bind(null,r=new H,2)));s=s.v}r?G(r,1,s):r=s}catch(e){G(r||(r=new H),2,e)}}(),r}(c,function(e){return t(c[e])})}(n,function(n){return Promise.resolve(t.removeSession(e,n)).then(function(){})});if(r&&r.then)return r.then(function(){})})}catch(e){return Promise.reject(e)}},n.makeSignatureProvider=function(e,t){var n=this;return{getAvailableKeys:function(){return Promise.resolve(e)},sign:function(e){try{var i=function(){return Promise.resolve(n.sendRequest(s,a,o)).then(function(t){var n=t.signatures,i=r.encode({object:t.transaction});return k({},e,{serializedTransaction:i,signatures:n})})},o=t||n.transport,s=p.fromTransaction(e.chainId,e.serializedTransaction,n.requestOptions),a=n.callbackService.create();s.setCallback(a.url,!0),s.setBroadcast(!1);var c=function(){if(o.prepare)return Promise.resolve(o.prepare(s)).then(function(e){s=e})}();return Promise.resolve(c&&c.then?c.then(i):i())}catch(e){return Promise.reject(e)}}}},n.touchSession=function(e,t,n){void 0===n&&(n=!1);try{var r=this;return Promise.resolve(r.listSessions(e)).then(function(i){var o=Q(t),s=i.findIndex(function(e){return Q(e)===o});s>=0&&i.splice(s,1),!1===n&&i.unshift(t);var a=r.sessionKey(e,"list");return Promise.resolve(r.storage.write(a,JSON.stringify(i))).then(function(){})})}catch(e){return Promise.reject(e)}},n.storeSession=function(e,t){try{var n=this,r=n.sessionKey(e,Q(t.auth)),i=JSON.stringify(t.serialize());return Promise.resolve(n.storage.write(r,i)).then(function(){return Promise.resolve(n.touchSession(e,t.auth)).then(function(){})})}catch(e){return Promise.reject(e)}},n.sessionKey=function(e,t){return[this.chainId.toString(),c.from(e).toString(),t].join("-")},t}();function Q(e){var t=s.from(e);return(t.actor.equals(v)?"<any>":String(t.actor))+"@"+(t.permission.equals(v)||t.permission.equals(m)?"<any>":String(t.permission))}export default $;export{R as CancelError,K as IdentityError,$ as Link,C as LinkChannelSession,A as LinkFallbackSession,E as LinkOptions,L as LinkSession,I as SessionError};
//# sourceMappingURL=index.m.js.map
