import{Checksum256 as t,TypeAlias as e,UInt8 as i,Variant as r,Name as n,Struct as a,PermissionLevel as o,Action as s,Transaction as c,Serializer as d,Bytes as f,ABIEncoder as l,ABIDecoder as u,ABI as h,TimePointSec as p,UInt16 as g,UInt32 as b,Signature as y}from"@greymass/eosio";const m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",v=new Uint8Array(256);for(let t=0;t<64;t++)v[m.charCodeAt(t)]=t;function _(t,e,i,r){var n,a=arguments.length,o=a<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,r);else for(var s=t.length-1;s>=0;s--)(n=t[s])&&(o=(a<3?n(o):a>3?n(e,i,o):n(e,i))||o);return a>3&&o&&Object.defineProperty(e,i,o),o}var w;!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.EOS=1]="EOS",t[t.TELOS=2]="TELOS",t[t.JUNGLE=3]="JUNGLE",t[t.KYLIN=4]="KYLIN",t[t.WORBLI=5]="WORBLI",t[t.BOS=6]="BOS",t[t.MEETONE=7]="MEETONE",t[t.INSIGHTS=8]="INSIGHTS",t[t.BEOS=9]="BEOS",t[t.WAX=10]="WAX",t[t.PROTON=11]="PROTON",t[t.FIO=12]="FIO"}(w||(w={}));let I=class extends t{static from(t){if(t instanceof this)return t;if("number"==typeof t&&!(t=S.get(t)))throw new Error("Unknown chain id alias");return super.from(t)}get chainVariant(){const t=this.chainName;return k.from(t!==w.UNKNOWN?["chain_alias",t]:this)}get chainName(){const t=this.hexString;for(const[e,i]of S)if(i===t)return e;return w.UNKNOWN}};I=_([e("chain_id")],I);let x=class extends i{};x=_([e("chain_alias")],x);let k=class extends r{get chainId(){return this.value instanceof I?this.value:I.from(this.value.value)}};k=_([r.type("variant_id",[x,I])],k);const S=new Map([[w.EOS,"aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906"],[w.TELOS,"4667b205c6838ef70ff7988f6e8257e8be0e1284a2f59699054a018f743b1d11"],[w.JUNGLE,"e70aaab8997e1dfce58fbfac80cbbb8fecec7b99cf982a9444273cbc64c41473"],[w.KYLIN,"5fff1dae8dc8e2fc4d5b23b2c7665c97f9e9d8edf2b6485a86ba311c25639191"],[w.WORBLI,"73647cde120091e0a4b85bced2f3cfdb3041e266cbbe95cee59b73235a1b3b6f"],[w.BOS,"d5a3d18fbb3c084e3b1f3fa98c21014b5f3db536cc15d08f9f6479517c6a3d86"],[w.MEETONE,"cfe6486a83bad4962f232d48003b1824ab5665c36778141034d75e57b956e422"],[w.INSIGHTS,"b042025541e25a472bffde2d62edd457b7e70cee943412b1ea0f044f88591664"],[w.BEOS,"b912d19a6abd2b1b05611ae5be473355d64d95aeff0c09bedc8c166cd6468fe4"],[w.WAX,"1064487b3cd1a897ce03ae5b6a865651747e2e152090f99c1d19d44e01aea5a4"],[w.PROTON,"384da888112027f0321850a169f737c33e53b388aad48b5adace4bab97f437e0"],[w.FIO,"21dcae42c0182200e93f954a074011f9048a7624c6fe81d3c9541a614a88bd1c"]]);var q;let O=class extends n{};O=_([e("account_name")],O);let N=class extends n{};N=_([e("permission_name")],N);let E=class extends a{};_([a.field(o,{optional:!0})],E.prototype,"permission",void 0),E=_([a.type("identity")],E);let A=class extends a{};_([a.field("name")],A.prototype,"scope",void 0),_([a.field(o,{optional:!0})],A.prototype,"permission",void 0),A=_([a.type("identity")],A);let T=class extends r{};T=_([r.type("variant_req",[s,{type:s,array:!0},c,E])],T);let R=class extends r{};R=_([r.type("variant_req",[s,{type:s,array:!0},c,A])],R);let B=q=class extends i{get broadcast(){return 0!=(this.value&q.broadcast)}set broadcast(t){this.setFlag(q.broadcast,t)}get background(){return 0!=(this.value&q.background)}set background(t){this.setFlag(q.background,t)}setFlag(t,e){e?this.value|=t:this.value&=~t}};B.broadcast=1,B.background=2,B=q=_([e("request_flags")],B);let M=class extends a{};_([a.field("string")],M.prototype,"key",void 0),_([a.field("bytes")],M.prototype,"value",void 0),M=_([a.type("info_pair")],M);let j=class extends a{};_([a.field(k)],j.prototype,"chain_id",void 0),_([a.field(T)],j.prototype,"req",void 0),_([a.field(B)],j.prototype,"flags",void 0),_([a.field("string")],j.prototype,"callback",void 0),_([a.field(M,{array:!0})],j.prototype,"info",void 0),j=_([a.type("signing_request")],j);let D=class extends a{};_([a.field(k)],D.prototype,"chain_id",void 0),_([a.field(R)],D.prototype,"req",void 0),_([a.field(B)],D.prototype,"flags",void 0),_([a.field("string")],D.prototype,"callback",void 0),_([a.field(M,{array:!0})],D.prototype,"info",void 0),D=_([a.type("signing_request")],D);let L=class extends a{};_([a.field("name")],L.prototype,"signer",void 0),_([a.field("signature")],L.prototype,"signature",void 0),L=_([a.type("request_signature")],L);const P=3,z=n.from("............1"),C=n.from("............2"),K=o.from({actor:z,permission:C});class U{constructor(t,e,i,r,n){if(e.flags.broadcast&&"identity"===e.req.variantName)throw new Error("Invalid request (identity request cannot be broadcast)");this.version=t,this.data=e,this.zlib=i,this.abiProvider=r,this.signature=n}static identityAbi(t){const e=d.synthesize(this.identityType(t));return e.actions=[{name:"identity",type:"identity",ricardian_contract:""}],e}static identityType(t){return 2===t?E:A}static storageType(t){return 2===t?j:D}static async create(t,e={}){let i;i=t.action?[t.action]:t.actions?t.actions:t.transaction&&t.transaction.actions||[];const r=i.filter(t=>!f.isBytes(t.data)&&void 0===t.data.constructor.abiName).map(t=>n.from(t.account)),a={};if(r.length>0){const t=e.abiProvider;if(!t)throw new Error("Missing abi provider");const i=await Promise.all(r.map(e=>t.getAbi(e)));for(const[t,e]of i.entries())a[r[t].toString()]=e}return this.createSync(t,e,a)}static createSync(t,e={},i={}){let r=2;const a={},o=t=>function(t,e){if(f.isBytes(t.data)||void 0!==t.data.constructor.abiName)return s.from(t);const i=e[String(n.from(t.account))];if(!i)throw new Error("Missing abi for "+t.account);return s.from(t,i)}(t,i);if(null===t.chainId&&(r=3),void 0!==t.identity)t.identity.scope&&(r=3),a.req=["identity",this.identityType(r).from(t.identity)];else if(!t.action||t.actions||t.transaction)if(!t.actions||t.action||t.transaction){if(!t.transaction||t.action||t.actions)throw new TypeError("Invalid arguments: Must have exactly one of action, actions or transaction");{const e=t.transaction;void 0===e.expiration&&(e.expiration="1970-01-01T00:00:00.000"),void 0===e.ref_block_num&&(e.ref_block_num=0),void 0===e.ref_block_prefix&&(e.ref_block_prefix=0),void 0===e.context_free_actions&&(e.context_free_actions=[]),void 0===e.transaction_extensions&&(e.transaction_extensions=[]),void 0===e.delay_sec&&(e.delay_sec=0),void 0===e.max_cpu_usage_ms&&(e.max_cpu_usage_ms=0),void 0===e.max_net_usage_words&&(e.max_net_usage_words=0),void 0===e.actions&&(e.actions=[]),void 0===e.context_free_actions&&(e.context_free_actions=[]),e.actions=e.actions.map(o),a.req=["transaction",e]}}else a.req=1===t.actions.length?["action",o(t.actions[0])]:["action[]",t.actions.map(o)];else a.req=["action",o(t.action)];a.chain_id=null===t.chainId?k.from(["chain_alias",0]):I.from(t.chainId||w.EOS).chainVariant;const c=B.from(0);let l="";if(c.broadcast=void 0!==t.broadcast?t.broadcast:"identity"!==a.req[0],"string"==typeof t.callback?l=t.callback:"object"==typeof t.callback&&(l=t.callback.url,c.background=t.callback.background||!1),a.flags=c,a.callback=l,a.info=[],"object"==typeof t.info)for(const e in t.info)if(Object.prototype.hasOwnProperty.call(t.info,e)){let i=t.info[e];i instanceof f||(i=d.encode({object:i})),a.info.push({key:e,value:i})}if(t.chainIds&&null===t.chainId){const e=t.chainIds.map(t=>I.from(t).chainVariant);a.info.push({key:"chain_ids",value:d.encode({object:e,type:{type:k,array:!0}})})}const u=new U(r,this.storageType(r).from(a),e.zlib,e.abiProvider);return e.signatureProvider&&u.sign(e.signatureProvider),u}static identity(t,e={}){let i={actor:t.account||z,permission:t.permission||C};return i.actor===z&&i.permission===C&&(i=void 0),this.createSync({...t,identity:{permission:i,scope:t.scope},broadcast:!1},e)}static fromTransaction(t,e,i={}){const r=I.from(t);e=f.from(e);const n=new l;return n.writeByte(2),n.writeArray(d.encode({object:r.chainVariant}).array),n.writeByte(2),n.writeArray(f.from(e).array),n.writeByte(B.broadcast),n.writeByte(0),n.writeByte(0),U.fromData(n.getData(),i)}static from(t,e={}){if("string"!=typeof t)throw new Error("Invalid request uri");const[i,r]=t.split(":");if("esr"!==i&&"web+esr"!==i)throw new Error("Invalid scheme");const n=function(t){const e=new Uint8Array(.75*t.length);let i,r,n,a,o=0;for(let s=0;s<t.length;s+=4)i=v[t.charCodeAt(s)],r=v[t.charCodeAt(s+1)],n=v[t.charCodeAt(s+2)],a=v[t.charCodeAt(s+3)],e[o++]=i<<2|r>>4,e[o++]=(15&r)<<4|n>>2,e[o++]=(3&n)<<6|63&a;return e}(r.startsWith("//")?r.slice(2):r);return U.fromData(n,e)}static fromData(t,e={}){const i=(t=f.from(t)).array[0],r=-129&i;if(2!==r&&3!==r)throw new Error("Unsupported protocol version");let n=t.droppingFirst(1);if(0!=(128&i)){if(!e.zlib)throw new Error("Compressed URI needs zlib");n=f.from(e.zlib.inflateRaw(n.array))}const a=new u(n.array),o=d.decode({data:a,type:this.storageType(r)});let s;return a.canRead()&&(s=d.decode({data:a,type:L})),new U(r,o,e.zlib,e.abiProvider,s)}sign(t){const e=this.getSignatureDigest();this.signature=L.from(t.sign(e))}getSignatureDigest(){const t=[this.version,114,101,113,117,101,115,116];return(new f).appending(t).appending(this.getData()).sha256Digest}setSignature(t,e){this.signature=L.from({signer:t,signature:e})}setCallback(t,e){this.data.callback=t,this.data.flags.background=e}setBroadcast(t){this.data.flags.broadcast=t}encode(t,e){const i=void 0!==t?t:void 0!==this.zlib;if(i&&void 0===this.zlib)throw new Error("Need zlib to compress");let r=this.version;const n=this.getData(),a=this.getSignatureData();let o=new Uint8Array(n.byteLength+a.byteLength);if(o.set(n,0),o.set(a,n.byteLength),i){const t=this.zlib.deflateRaw(o);o.byteLength>t.byteLength&&(r|=128,o=t)}const s=new Uint8Array(1+o.byteLength);s[0]=r,s.set(o,1);let c="esr:";return!1!==e&&(c+="//"),c+function(t){const e=t.byteLength,i=e%3,r=e-i,n=[];let a,o,s,c,d;for(let e=0;e<r;e+=3)d=t[e]<<16|t[e+1]<<8|t[e+2],a=(16515072&d)>>18,o=(258048&d)>>12,s=(4032&d)>>6,c=63&d,n.push(m[a]+m[o]+m[s]+m[c]);return 1===i?(d=t[r],a=(252&d)>>2,o=(3&d)<<4,n.push(m[a]+m[o])):2===i&&(d=t[r]<<8|t[r+1],a=(64512&d)>>10,o=(1008&d)>>4,s=(15&d)<<2,n.push(m[a]+m[o]+m[s])),n.join("")}(s)}getData(){return d.encode({object:this.data}).array}getSignatureData(){return this.signature?d.encode({object:this.signature}).array:new Uint8Array(0)}getRequiredAbis(){return this.getRawActions().filter(t=>!J(t)).map(t=>t.account).filter((t,e,i)=>i.indexOf(t)===e)}requiresTapos(){const t=this.getRawTransaction();return!this.isIdentity()&&!F(t)}async fetchAbis(t){const e=this.getRequiredAbis();if(e.length>0){const i=t||this.abiProvider;if(!i)throw new Error("Missing ABI provider");const r=new Map;return await Promise.all(e.map(async function(t){r.set(t.toString(),h.from(await i.getAbi(t)))})),r}return new Map}resolveActions(t,e){return this.getRawActions().map(i=>{let r;if(J(i))r=this.constructor.identityAbi(this.version);else{const e=t.get(i.account.toString());if(!e)throw new Error("Missing ABI definition for "+i.account);r=h.from(e)}if(!r.getActionType(i.name))throw new Error(`Missing type for action ${i.account}:${i.name} in ABI`);let a=i.decodeData(r),s=i.authorization;if(e){const t=o.from(e),i=e=>{if(e instanceof n)return e.equals(z)?t.actor:e.equals(C)?t.permission:e;if(Array.isArray(e))return e.map(i);if("object"==typeof e&&null!==e){for(const t of Object.keys(e))e[t]=i(e[t]);return e}return e};a=i(a),s=s.map(e=>{let{actor:i,permission:r}=e;return i.equals(z)&&(i=t.actor),r.equals(C)&&(r=t.permission),r.equals(z)&&(r=t.permission),o.from({actor:i,permission:r})})}return{...i,authorization:s,data:a}})}resolveTransaction(t,e,i={}){const r=this.getRawTransaction();if(this.isIdentity()||F(r))this.isIdentity()&&this.version>2&&(r.expiration=i.expiration?p.from(i.expiration):G(i.timestamp,i.expire_seconds));else if(void 0!==i.expiration&&void 0!==i.ref_block_num&&void 0!==i.ref_block_prefix)r.expiration=p.from(i.expiration),r.ref_block_num=g.from(i.ref_block_num),r.ref_block_prefix=b.from(i.ref_block_prefix);else{if(void 0===i.block_num||void 0===i.ref_block_prefix||void 0===i.timestamp)throw new Error("Invalid transaction context, need either a reference block or explicit TaPoS values");r.expiration=G(i.timestamp,i.expire_seconds),r.ref_block_num=g.from(i.block_num),r.ref_block_prefix=b.from(i.ref_block_prefix)}const n=this.resolveActions(t,e),a=r.context_free_actions;return{...r,context_free_actions:a,actions:n}}resolve(t,e,i={}){const r=this.resolveTransaction(t,e,i),n=r.actions.map(e=>{let i;if(i=J(e)?this.constructor.identityAbi(this.version):t.get(e.account.toString()),!i)throw new Error("Missing ABI definition for "+e.account);const r=i.getActionType(e.name),n=d.encode({object:e.data,type:r,abi:i});return s.from({...e,data:n})}),a=c.from({...r,actions:n});let f;if(this.isMultiChain()){if(!i.chainId)throw new Error("Missing chosen chain ID for multi-chain request");f=I.from(i.chainId);const t=this.getChainIds();if(t&&!t.some(t=>f.equals(t)))throw new Error("Trying to resolve for chain ID not defined in request")}else f=this.getChainId();return new W(this,o.from(e),a,r,f)}getChainId(){return this.data.chain_id.chainId}getChainIds(){if(!this.isMultiChain())return null;const t=this.getInfoKey("chain_ids",{type:k,array:!0});return t?t.map(t=>t.chainId):null}setChainIds(t){const e=t.map(t=>I.from(t).chainVariant);this.setInfoKey("chain_ids",e,{type:k,array:!0})}isMultiChain(){return 0===this.data.chain_id.variantIdx&&this.data.chain_id.value.value===w.UNKNOWN}getRawActions(){const t=this.data.req;switch(t.variantName){case"action":return[t.value];case"action[]":return t.value;case"identity":if(2===this.version){const e=t.value;let i="0101000000000000000200000000000000",r=[K];return e.permission&&(i=d.encode({object:e}),r=[e.permission]),[s.from({account:"",name:"identity",authorization:r,data:i})]}{let{scope:e,permission:i}=t.value;i||(i=K);const r=d.encode({object:{scope:e,permission:i},type:A});return[s.from({account:"",name:"identity",authorization:[i],data:r})]}case"transaction":return t.value.actions;default:throw new Error("Invalid signing request data")}}getRawTransaction(){const t=this.data.req;switch(t.variantName){case"transaction":return c.from({...t.value});case"action":case"action[]":case"identity":return c.from({actions:this.getRawActions(),context_free_actions:[],transaction_extensions:[],expiration:"1970-01-01T00:00:00.000",ref_block_num:0,ref_block_prefix:0,max_cpu_usage_ms:0,max_net_usage_words:0,delay_sec:0});default:throw new Error("Invalid signing request data")}}isIdentity(){return"identity"===this.data.req.variantName}shouldBroadcast(){return!this.isIdentity()&&this.data.flags.broadcast}getIdentity(){if(!this.isIdentity())return null;const t=this.data.req.value;return t.permission&&!t.permission.actor.equals(z)?t.permission.actor:null}getIdentityPermission(){if(!this.isIdentity())return null;const t=this.data.req.value;return t.permission&&!t.permission.permission.equals(C)?t.permission.permission:null}getIdentityScope(){return!this.isIdentity()||this.version<=2?null:this.data.req.value.scope}getRawInfo(){const t={};for(const{key:e,value:i}of this.data.info)t[e]=i;return t}getRawInfoKey(t){const e=this.data.info.find(e=>e.key===t);if(e)return e.value}setRawInfoKey(t,e){let i=this.data.info.find(e=>e.key===t);i?i.value=f.from(e):(i=M.from({key:t,value:e}),this.data.info.push(i))}setInfoKey(t,e,i){this.setRawInfoKey(t,d.encode({object:e,type:i}))}getInfoKey(t,e){const i=this.getRawInfoKey(t);if(i)return d.decode({data:i,type:e})}clone(){let t;this.signature&&(t=L.from(JSON.parse(JSON.stringify(this.signature))));const e=this.constructor.storageType(this.version).from(JSON.parse(JSON.stringify(this.data)));return new U(this.version,e,this.zlib,this.abiProvider,t)}toString(){return this.encode()}toJSON(){return this.encode()}}class W{constructor(t,e,i,r,n){this.request=t,this.signer=e,this.transaction=i,this.resolvedTransaction=r,this.chainId=n}static async fromPayload(t,e={}){const i=U.from(t.req,e),r=await i.fetchAbis();return i.resolve(r,{actor:t.sa,permission:t.sp},{ref_block_num:t.rbn,ref_block_prefix:t.rid,expiration:t.ex,chainId:t.cid})}get serializedTransaction(){return d.encode({object:this.transaction}).array}get signingDigest(){return this.transaction.signingDigest(this.chainId)}getCallback(t,e){const{callback:i,flags:r}=this.request.data;if(!i||0===i.length)return null;if(!t||0===t.length)throw new Error("Must have at least one signature to resolve callback");const n=t.map(t=>y.from(t)),a={sig:String(n[0]),tx:String(this.transaction.id),rbn:String(this.transaction.ref_block_num),rid:String(this.transaction.ref_block_prefix),ex:String(this.transaction.expiration),req:this.request.encode(),sa:String(this.signer.actor),sp:String(this.signer.permission),cid:String(this.chainId)};for(const[t,e]of n.slice(1).entries())a["sig"+t]=String(e);e&&(a.bn=String(b.from(e)));const o=i.replace(/({{([a-z0-9]+)}})/g,(t,e,i)=>a[i]||"");return{background:r.background,payload:a,url:o}}}function J(t){const e=n.from(t.account),i=n.from(t.name);return e.rawValue.equals(0)&&i.equals("identity")}function F(t){return!(0===t.expiration.value.value&&0===t.ref_block_num.value&&0===t.ref_block_prefix.value)}function G(t,e=60){const i=p.from(t||new Date),r=b.from(e);return p.fromMilliseconds(i.toMilliseconds()+1e3*r.value)}export{O as AccountName,x as ChainAlias,I as ChainId,k as ChainIdVariant,w as ChainName,E as IdentityV2,A as IdentityV3,M as InfoPair,N as PermissionName,K as PlaceholderAuth,z as PlaceholderName,C as PlaceholderPermission,P as ProtocolVersion,j as RequestDataV2,D as RequestDataV3,B as RequestFlags,L as RequestSignature,T as RequestVariantV2,R as RequestVariantV3,W as ResolvedSigningRequest,U as SigningRequest};
//# sourceMappingURL=index.esm.js.map
