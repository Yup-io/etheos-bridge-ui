{"code":"import { __assign, __spreadArrays } from \"tslib\";\r\nimport { getPoseValues } from '../inc/selectors';\r\nimport { invariant } from 'hey-listen';\r\nexport var resolveProp = function (target, props) {\r\n    return typeof target === 'function' ? target(props) : target;\r\n};\r\nvar poseDefault = function (pose, prop, defaultValue, resolveProps) {\r\n    return pose && pose[prop] !== undefined\r\n        ? resolveProp(pose[prop], resolveProps)\r\n        : defaultValue;\r\n};\r\nvar startChildAnimations = function (children, next, pose, props) {\r\n    var animations = [];\r\n    var delay = poseDefault(pose, 'delayChildren', 0, props);\r\n    var stagger = poseDefault(pose, 'staggerChildren', 0, props);\r\n    var staggerDirection = poseDefault(pose, 'staggerDirection', 1, props);\r\n    var maxStaggerDuration = (children.size - 1) * stagger;\r\n    var generateStaggerDuration = staggerDirection === 1\r\n        ? function (i) { return i * stagger; }\r\n        : function (i) { return maxStaggerDuration - i * stagger; };\r\n    Array.from(children).forEach(function (child, i) {\r\n        animations.push(child.set(next, {\r\n            delay: delay + generateStaggerDuration(i)\r\n        }));\r\n    });\r\n    return animations;\r\n};\r\nvar resolveTransition = function (transition, key, value, props, convertTransitionDefinition, getInstantTransition) {\r\n    var resolvedTransition;\r\n    if (typeof transition === 'function') {\r\n        var resolvedTransitionMap = transition(props);\r\n        resolvedTransition = resolveTransition(resolvedTransitionMap, key, value, props, convertTransitionDefinition, getInstantTransition);\r\n    }\r\n    else if (transition[key] || transition.default) {\r\n        var keyTransition = transition[key] || transition.default;\r\n        if (typeof keyTransition === 'function') {\r\n            resolvedTransition = keyTransition(props);\r\n        }\r\n        else {\r\n            resolvedTransition = keyTransition;\r\n        }\r\n    }\r\n    else {\r\n        resolvedTransition = transition;\r\n    }\r\n    return resolvedTransition === false\r\n        ? getInstantTransition(value, props)\r\n        : convertTransitionDefinition(value, resolvedTransition, props);\r\n};\r\nvar findInsertionIndex = function (poseList, priorityList, priorityIndex) {\r\n    var insertionIndex = 0;\r\n    for (var i = priorityIndex - 1; i >= 0; i--) {\r\n        var nextHighestPriorityIndex = poseList.indexOf(priorityList[i]);\r\n        if (nextHighestPriorityIndex !== -1) {\r\n            insertionIndex = nextHighestPriorityIndex + 1;\r\n            break;\r\n        }\r\n    }\r\n    return insertionIndex;\r\n};\r\nvar applyValues = function (toApply, values, props, setValue, setValueNative) {\r\n    invariant(typeof toApply === 'object', 'applyAtStart and applyAtEnd must be of type object');\r\n    return Object.keys(toApply).forEach(function (key) {\r\n        var valueToSet = resolveProp(toApply[key], props);\r\n        values.has(key)\r\n            ? setValue(values.get(key), valueToSet)\r\n            : setValueNative(key, valueToSet, props);\r\n    });\r\n};\r\nvar createPoseSetter = function (setterProps) {\r\n    var state = setterProps.state, poses = setterProps.poses, startAction = setterProps.startAction, stopAction = setterProps.stopAction, getInstantTransition = setterProps.getInstantTransition, addActionDelay = setterProps.addActionDelay, getTransitionProps = setterProps.getTransitionProps, resolveTarget = setterProps.resolveTarget, transformPose = setterProps.transformPose, posePriority = setterProps.posePriority, convertTransitionDefinition = setterProps.convertTransitionDefinition, setValue = setterProps.setValue, setValueNative = setterProps.setValueNative, forceRender = setterProps.forceRender;\r\n    return function (next, nextProps, propagate) {\r\n        if (nextProps === void 0) { nextProps = {}; }\r\n        if (propagate === void 0) { propagate = true; }\r\n        var children = state.children, values = state.values, props = state.props, activeActions = state.activeActions, activePoses = state.activePoses;\r\n        var _a = nextProps.delay, delay = _a === void 0 ? 0 : _a;\r\n        var hasChildren = children.size;\r\n        var baseTransitionProps = __assign(__assign({}, props), nextProps);\r\n        var nextPose = poses[next];\r\n        var getChildAnimations = function () {\r\n            return hasChildren && propagate\r\n                ? startChildAnimations(children, next, nextPose, baseTransitionProps)\r\n                : [];\r\n        };\r\n        var getParentAnimations = function () {\r\n            if (!nextPose)\r\n                return [];\r\n            var applyAtStart = nextPose.applyAtStart;\r\n            if (applyAtStart) {\r\n                applyValues(applyAtStart, values, baseTransitionProps, setValue, setValueNative);\r\n                if (forceRender)\r\n                    forceRender(baseTransitionProps);\r\n            }\r\n            if (transformPose)\r\n                nextPose = transformPose(nextPose, next, state);\r\n            var preTransition = nextPose.preTransition, getTransition = nextPose.transition, applyAtEnd = nextPose.applyAtEnd;\r\n            if (preTransition)\r\n                preTransition(baseTransitionProps);\r\n            var animations = Object.keys(getPoseValues(nextPose)).map(function (key) {\r\n                var valuePoses = activePoses.has(key)\r\n                    ? activePoses.get(key)\r\n                    : (activePoses.set(key, []), activePoses.get(key));\r\n                var existingIndex = valuePoses.indexOf(next);\r\n                if (existingIndex !== -1)\r\n                    valuePoses.splice(existingIndex, 1);\r\n                var priority = posePriority ? posePriority.indexOf(next) : 0;\r\n                var insertionIndex = priority <= 0\r\n                    ? 0\r\n                    : findInsertionIndex(valuePoses, posePriority, priority);\r\n                valuePoses.splice(insertionIndex, 0, next);\r\n                return insertionIndex === 0\r\n                    ? new Promise(function (complete) {\r\n                        var value = values.get(key);\r\n                        var transitionProps = __assign(__assign({}, baseTransitionProps), { key: key,\r\n                            value: value });\r\n                        var target = resolveTarget(value, resolveProp(nextPose[key], transitionProps));\r\n                        if (activeActions.has(key))\r\n                            stopAction(activeActions.get(key));\r\n                        var resolveTransitionProps = __assign(__assign({ to: target }, transitionProps), getTransitionProps(value, target, transitionProps));\r\n                        var transition = resolveTransition(getTransition, key, value, resolveTransitionProps, convertTransitionDefinition, getInstantTransition);\r\n                        var poseDelay = delay || resolveProp(nextPose.delay, transitionProps);\r\n                        if (poseDelay) {\r\n                            transition = addActionDelay(poseDelay, transition);\r\n                        }\r\n                        activeActions.set(key, startAction(value, transition, complete));\r\n                    })\r\n                    : Promise.resolve();\r\n            });\r\n            return applyAtEnd\r\n                ? [\r\n                    Promise.all(animations).then(function () {\r\n                        applyValues(applyAtEnd, values, baseTransitionProps, setValue, setValueNative);\r\n                    })\r\n                ]\r\n                : animations;\r\n        };\r\n        if (nextPose && hasChildren) {\r\n            if (resolveProp(nextPose.beforeChildren, baseTransitionProps)) {\r\n                return Promise.all(getParentAnimations()).then(function () {\r\n                    return Promise.all(getChildAnimations());\r\n                });\r\n            }\r\n            else if (resolveProp(nextPose.afterChildren, baseTransitionProps)) {\r\n                return Promise.all(getChildAnimations()).then(function () {\r\n                    return Promise.all(getParentAnimations());\r\n                });\r\n            }\r\n        }\r\n        return Promise.all(__spreadArrays(getParentAnimations(), getChildAnimations()));\r\n    };\r\n};\r\nexport default createPoseSetter;\r\n//# sourceMappingURL=setter.js.map","references":["/Users/mattperry/Sites/popmotion/packages/pose-core/src/types.ts","/Users/mattperry/Sites/popmotion/packages/pose-core/src/inc/selectors.ts","/Users/mattperry/Sites/popmotion/node_modules/hey-listen/lib/index.d.ts"],"map":"{\"version\":3,\"file\":\"setter.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../src/factories/setter.ts\"],\"names\":[],\"mappings\":\"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\"}"}
